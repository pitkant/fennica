---
title: "Patterns in Knowledge Production: Political Ruptures and Imperial Dynamics Shaping Public Discourse in Sweden and Finland, 1640–1828"
author: "Mikko Tolonen, Leo Lahti, Hege Roivainen, Jani Marjanen"
date: "`r Sys.Date()`"
output: 
  beamer_presentation:
    theme: "boxes"
    colortheme: "orchid"
    fonttheme: "professionalfonts"
fontsize: 13pt
---

```{r init, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
# Default time span
min.year <- 1488
max.year <- 1828

library(ggmap)
library(gisfin)
library(stringr)
library(dplyr)
library(tidyr)
library(reshape2)
library(ggplot2)
library(bibliographica)
library(fennica)
library(sorvi)
library(devtools)
# install_github("ropengov/gisfin")
# devtools::install_github('cttobin/ggthemr')
#library(ggthemr)

knitr::opts_chunk$set(echo = FALSE)
#knitr::opts_chunk$set(fig.path = "slides_201606_Krakow/", dev="CairoPNG")
knitr::opts_chunk$set(fig.path = "20170201_manuscript/")

# Set locale
tmp <- Sys.setlocale(locale="UTF-8") 

# Nice theme
theme_set(theme_bw(26))

# Nice default themes
# https://github.com/cttobin/ggthemr#palettes
#ggthemr('fresh', text_size = 20)
# ggthemr('greyscale', text_size = 20)
#ggthemr('light', text_size = 20)
# ggthemr('pale', text_size = 20)
#ggthemr_reset() # Reset theme
```


```{r 201606krakow-init2, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
# Full combined catalogue (Fen + Kun) with marked duplicates
df.combined.preprocessed <- readRDS("df.combined.Rds")
# Data with duplicates removed
df.full <- df.combined.preprocessed %>% filter(!remove)
# Calculate title length (nchar and word count)
df.full$title_length_nchar <- nchar(df.full$title)
df.full$title_length_wordcount <- sapply(strsplit(df.full$title, " "), length)
df.full$title_length_wordcount[is.na(df.full$title)] <- NA

# Data with years limited as well
df0 <- df.full %>% filter(publication_year >= min.year & publication_year <= max.year)
```

---


### Fig. 1: Number of publication places over time

```{r Fig1, message=FALSE, warning=FALSE, fig.width=10, fig.height=4, echo=FALSE}
library(dplyr)
library(ggplot2)
# theme_set(theme_bw(20))

df <- df0 %>% filter(publication_year >=1640 & publication_year <=1828) %>%
              group_by(catalog, publication_decade) %>%
	      summarise(n = length(unique(na.omit(publication_place))))
p <- ggplot(df, aes(x = publication_decade, y = n, shape = catalog, linetype = catalog)) + 
       geom_point(size = 4) + 
       geom_line(size = 1) + 
       ylab("Places (n)") + xlab("Publication year") +
       scale_color_manual(values = c("blue", "darkgreen")) + 
       guides(shape = guide_legend(title = "Catalog", reverse = TRUE)) +
       guides(linetype = guide_legend(title = "Catalog", reverse = TRUE)) +       
       ggtitle("Unique publication places")
print(p)
```

---


### Fig 2: Title count over time

```{r Fig2, message=FALSE, warning=FALSE, fig.width=10, fig.height=4, echo=FALSE}
library(dplyr)
library(ggplot2)
theme_set(theme_bw(20))
df <- df0 %>% filter(publication_year >=1640 & publication_year <=1828) %>% group_by(catalog, publication_decade) %>% tally()
p <- ggplot(df, aes(x = publication_decade, y = n, shape = catalog, linetype = catalog)) + 
       geom_point(size = 4) + 
       geom_line(size = 1) + 
       ylab("Documents (n)") + xlab("Publication year") +
       scale_color_manual(values = c("blue", "darkgreen")) +
       guides(shape = guide_legend(title = "Catalog", reverse = TRUE)) +
       guides(linetype = guide_legend(title = "Catalog", reverse = TRUE)) +  
       ggtitle("Title count")
print(p)
```

---

### Fig 3: Rise of the Octavo

Paper consumption for various document formats over time.

```{r Fig3, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, fig.width=9, fig.height=5, fig.show="hold"}
pics <- list()
for (catal in unique(df00$catalog)) {

  if (catal == "Kungliga") {
    df00 <- df.full %>% filter(publication_year >= min.year & publication_year <= max.year)
  } else if (catal == "Fennica") {
    df00 <- df.full %>% filter(publication_year >= min.year & publication_year <= 1900)
  }

  df2 <- subset(df00, catalog == catal) %>% group_by(publication_decade, gatherings) %>% summarize(paper = sum(paper, na.rm = TRUE), n = n())

  df2 <- filter(df2, gatherings %in% setdiff(names(which(table(df2$gatherings) >= 20)), "NA"))
  df2$highlight <- rep("Other", nrow(df2))
  df2$highlight[df2$gatherings == "8vo"] <- "Octavo"
  df2$gatherings <- factor(df2$gatherings, levels = levels(df.full$gatherings))

  p <- ggplot(df2, aes(y = paper,
                       x = publication_decade,
  	       shape = gatherings,
		       linetype = gatherings))		       
  p <- p + geom_point(size = 4)
  p <- p + geom_smooth(method = "loess", size = 1,
         aes(color = highlight, fill = highlight))
  p <- p + scale_color_manual(values = c("darkgreen", "darkgray"))
  p <- p + scale_fill_manual(values = c("darkgreen", "darkgray"))  	 
  p <- p + xlab("Year")
  p <- p + ylab("Paper (sheets)")
  p <- p + ylim(c(0, max(na.omit(df2$paper))))
  p <- p + guides(linetype = guide_legend(keywidth = 5, title = "Gatherings"),
       	          shape = guide_legend(keywidth = 5, title = "Gatherings"),
       	          fill = "none", # guide_legend(title = "Gatherings"),
       	          color = "none" # guide_legend(title = "Gatherings")
		  )
  p <- p + ggtitle(paste("Paper consumption (", catal, ")", sep = ""))
  pics[[catal]] <- p
}
```

```{r Fig3A, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, fig.width=9, fig.height=5}
print(pics[[1]])
```

---

```{r Fig3B, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, fig.width=9, fig.height=5}
print(pics[[2]])
```

---


### Fig 4: Median title length (word count)

Loess smoothing.

```{r Fig4, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=4, fig.width=11}
df <- df.full %>% filter(publication_year >= 1640 &
                         publication_year <= 1911) %>%
              group_by(catalog, publication_year) %>%
              summarize(title_length = median(title_length_wordcount),
	      		n = n())

pics <- list()
for (catal in unique(df$catalog)) {
  pics[[catal]] <- ggplot(subset(df, catalog == catal), aes(x = publication_year, y = title_length)) +
       geom_point(aes(size = n)) +
       geom_smooth(color = "black") +
       ggtitle(paste("Mean title length (", catal, ")", sep = "")) + 
       xlab("Publication year") +
       ylab("Title length (word count)")
}     


library(gridExtra)
grid.arrange(pics[[1]], pics[[2]], nrow = 1)
```

---


### Fig 5: Turku as Swedish university town

Proportions for title count and paper in Swedish University towns
 
```{r Fig5, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, fig.width=13, fig.height=6}
pics <- list()
for (catalogue in na.omit(unique(df0$catalog))) {

df <- df0 %>% filter(catalog == catalogue)%>%
        filter(publication_year >= 1640 & publication_year <= 1828)
places <- c("Stockholm", "Uppsala", "Lund", "Greifswald", "Tartu", "Turku")
df$publication_place[!df$publication_place %in% places] <- "Other"
df <- subset(df, !is.na(df$publication_place))
#df$publication_place <- factor(df$publication_place, levels = c(places, "Other"))
library(reshape2)
library(magrittr)
library(dplyr)
library(tidyr)

df <- df %>% group_by(publication_decade, publication_place) %>%
             summarise(n = n(),
                paper = sum(paper, na.rm = TRUE),
		       publishers = length(na.omit(unique(publisher)))
		       )


# Calculate percentages
for (varname in c("n", "paper", "publishers")) {

  df$varname <- df[[varname]]
  dff <- df %>% select(publication_decade, publication_place, varname)
  dff <- spread(dff, publication_place, varname, fill = 0)
  dff[, -1] <- 100 * t(apply(dff[, -1], 1, function (x) {x/sum(x)}))
  dff <- melt(dff, "publication_decade");
  colnames(dff) <- c("publication_decade", "publication_place", "f")

  theme_set(theme_bw(20))
  p <- ggplot(dff, aes(x = publication_decade, y = f)) +
     geom_bar(position = "stack", stat = "identity", color = "black",
       aes(fill = publication_place)) + 
     xlab("Publication year") +
     #scale_fill_brewer(palette="Spectral")
     scale_fill_brewer(palette="Greys") 
     if (varname == "n") {
       p <- p + ggtitle(paste("Title count (", catalogue, ")", sep = "")) + 
                ylab("Title count frequency (%)") 
     }
     if (varname == "paper") {
       p <- p + ggtitle(paste("Paper (", catalogue, ")", sep = "")) +
                ylab("Paper (%)")        
     }
     if (varname == "publishers") {
       p <- p + ggtitle(paste("Publishers (", catalogue, ")", sep = "")) +
                       ylab("Publishers (%)")
     }     
  p <- p + guides(fill = guide_legend(title = "")) 

  pics[[paste(catalogue, varname, sep = "-")]] <- p

}
}
library(gridExtra)
grid.arrange(pics[[1]], pics[[2]], pics[[4]], pics[[5]], nrow = 2)
rm(pics)
```

---


### Fig 6: Publishing activity over time (Kungliga)

```{r Fig6, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=4}
library(magrittr)
library(ggplot2)
library(dplyr)
v <- seq(1500, 1800, 100)
theme_set(theme_bw(20))
df <- df0 %>% filter(catalog == "Kungliga")

# Add indicator of the publication period
df$period <- cut(df$publication_year,
           breaks = c(1757, 1766, 1775, 1783),
		 include.lowest = TRUE,
		 right = FALSE
		 )
df$period <- gsub("\\[", "", df$period)
df$period <- gsub("\\)", "", df$period)
df$period <- gsub(",", ",", df$period)
df$period <- gsub("\\]", "", df$period)

# Remove entries outside the investigated publication periods
df.all <- df %>% filter(!is.na(period)) %>%
	     group_by(period) %>%
	     summarise(n = n(),
		  paper = sum(paper, na.rm = TRUE)) %>%
        mutate(paper.per.title = paper/n)

# Remove entries outside the investigated publication periods
df.cities <- df %>% filter(!is.na(period)) %>%
	     group_by(period, publication_place) %>%
	     summarise(n = n(),
		  paper = sum(paper, na.rm = TRUE)) %>%
        mutate(paper.per.title = paper/n)		 

df.all$publication_place <- "All"
df <- bind_rows(df.all, df.cities) %>%
        filter(publication_place %in% c("Stockholm", "Uppsala", "Lund", "All"))

p <- ggplot(df,
       aes(fill = period, y = paper.per.title, x = publication_place)) + 
       geom_bar(stat = "identity", color = "black", position = "dodge") +
       #scale_x_discrete(labels = c("1757-1765", "1766-1774", "1775-1783")) +
       #scale_fill_manual(values = c("darkgreen", "darkgray"))
       scale_fill_brewer(palette="Greys") +              
       guides(fill = guide_legend(title = "Period")) +
       ylab("Paper (sheets)") + xlab("") +
       ggtitle("Paper consumption per title")

print(p)
```

---


### Fig. 7: Publishing activity and riksdagar: Kungliga

```{r Fig7, echo=FALSE, message=FALSE, warning=FALSE, fig.width=11, fig.height=4}

minyear <- 1700
maxyear <- 1830
catal <- "Kungliga"

library(magrittr)
library(ggplot2)
library(dplyr)
library(ggplot2)
library(reshape2)

  # Use timeinterval year intervals
  dfsel = subset(df0, catalog == catal)

  df <- df0
  df = subset(df, catalog == catal)
  df <- subset(df, publication_year >= minyear & publication_year <= maxyear)
  df <- subset(dfsel, publication_year >= minyear & publication_year <= maxyear)

  timeinterval <- 1
  df$timeunit <- round(df$publication_year/timeinterval)*timeinterval 

  df$unity = rep(1, nrow(df))
  publications <- tapply(df$unity, list(df$timeunit), sum)

  publications[is.na(publications)] <- 0 # Set NAs to 0
  publications <- publications/timeinterval # Instead of decadal sum, use average annual output 
  dfm <- melt(publications) 
  names(dfm) <- c("Time", "Documents")
  dfm <- base::transform(dfm, date = as.numeric(as.character(Time)))
  ymin = min(dfm$Documents)
  ymax = max(dfm$Documents)

  rect_left <- c(min(na.omit(dfm$date)),
               1710-.5, 1710+.5, #
               1713-.5, 1714+.5, #
	       
               1719-.5, 1719+.5, # Stockholm 20 januari 1719 1 juni 1719
               1720-.5, 1720+.5, # Stockholm 20 januari 1719 1 juni 1719
               1723-.5, 1723+.5, # Stockholm 20 januari 1719 1 juni 1719

               1726-.5, 1727+.5, # Stockholm 20 januari 1719 1 juni 1719

               1731-.5, 1731+.5, # Stockholm 20 januari 1719 1 juni 1719	       	       
	       
               1734-.5, 1734+.5, # Stockholm 14 maj 1734 14 december 1734

               1738-.5, 1739+.5, #

               1740-.5, 1741+.5, #

               1742-.5, 1743+.5, #
               1746-.5, 1747+.5, #

               1751-.5, 1752+.5, #
               1755-.5, 1756+.5, #
               1760-.5, 1762+.5, #
	       
               1765-.5, 1766+.5, # Stockholm 21 februari 1765 21 oktober 1766
               1769-.5, 1770+.5, # Norrköping & Stockholm 22 april 1769 5 februari 1770
               1771-.5, 1772+.5, # Stockholm 19 juni 1771 12 september 1772

               1778-.5, 1779+.5, #
               1786-.5, 1786+.5, #
               1789-.5, 1789+.5, #

               1792-.5, 1792+.5, # Gävle 26 januari 1792 24 februari 1792

               1800-.5, 1800+.5, #
               1809-.5, 1810+.5, #
               1812-.5, 1812+.5, #
               1815-.5, 1815+.5, #
               1817-.5, 1818+.5, #
               1823-.5, 1823+.5, #
               1828-.5, 1830+.5, #

               max(na.omit(dfm$date)))
  rectangles <- data.frame(
    xmin = rect_left[-length(rect_left)],
    xmax = rect_left[-1],
    ymin = ymin,
    ymax = ymax
    )

  rectangles$shade <- rep(c("Background", "Highlight"), length = nrow(rectangles))
  riksplace <- c(rep("Unknown", 2), "Stockholm", "Stockholm", "Stockholm", "Norrköping", "Stockholm", rep("Unknown", 3), "Gävle", rep("Unknown", 7))
  #cols <- c("white", "Purple", "yellow", "orange", "darkgray")
  cols <- c("white", "lightgray", "gray", "darkgray")
  rectangles$shade[rectangles$shade == "Highlight"] <- rep(cols, length(which(rectangles$shade == "Highlight")))
  rectangles$shade <- factor(rectangles$shade)  

  rectangles$place <- rectangles$shade
  rectangles$place[rectangles$place == "Highlight"] <- riksplace
  rectangles$place[rectangles$place == "Background"] <- "" 


  # Draw Figure
  theme_set(theme_bw(20))
  p <- ggplot() +
         geom_rect(data = rectangles, 
           aes(xmin=xmin, xmax=xmax,
	       ymin=ymin, ymax=ymax,
	       fill=shade), alpha=0.8) +
         #scale_fill_manual(values = cols) +
         scale_fill_brewer(palette="Greys") +
	 guides(fill = "none")

  # p <- p + geom_text(data = rectangles, angle = 90, aes(x=xmin + .5, y=.9*ymax, label=place), size = 6)
	     
  p <- p + geom_line(data = dfm, aes(x = date, y = Documents), col = "black")
  p <- p + geom_point(data = dfm, aes(x = date, y = Documents), col = "black")
  p <- p + scale_x_continuous(breaks=seq(min(dfm$date), max(dfm$date), 10))
  p <- p + ylab("Title count (n)")
  p <- p + xlab("Year")
  p <- p + ggtitle(paste(catal, " ", minyear, "-", maxyear, sep = ""))
  print(p)

```

---


### Fig 8: Publishers in Swedish University towns (Fennica)

Turku, Vaasa and Vyborg from Fennica; Stockholm, Lund, Uppsala, Greifswald, Tartu from Kungliga.

```{r Fig8, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=5, fig.width=12}
df <- df0
catal <- "Fennica"
df <- df %>%
        filter(catalog == catal) %>%
	filter(country == "Finland" | publication_place == "Vyborg") %>%
        filter(publication_year >= 1640 & publication_year <= 1828)

# Top publication places
library(bibliographica)

top <- c("Turku", "Vaasa", "Vyborg")
df <- df %>%	
        filter(publication_place %in% top) %>%	
        select(publication_decade, publication_place, publisher)
	
npub <- unique(df) %>% group_by(publication_decade, publication_place) %>% tally()
npub$publication_place <- factor(npub$publication_place, levels = top)
npub.fennica <- npub

df <- df0
catalogue <- "Kungliga"
df <- df %>%
        filter(catalog == catalogue) %>%
        filter(publication_year >= 1640 & publication_year <= 1828)

# Selected publication places
top <- c("Stockholm", "Lund", "Uppsala", "Greifswald", "Tartu")
df <- df %>%	
        filter(publication_place %in% top) %>%	
        select(publication_decade, publication_place, publisher)
	
npub <- unique(df) %>% group_by(publication_decade, publication_place) %>% tally()
npub$publication_place <- factor(npub$publication_place, levels = top)
npub.kungliga <- npub

npub <- bind_rows(npub.fennica, npub.kungliga)

# Order by total publishing activity
npub$publication_place <- factor(npub$publication_place, levels = (npub %>% group_by(publication_place) %>% summarise(total = sum(n)) %>% arrange(desc(total)))$publication_place)
npub <- npub %>% arrange(publication_place)
npub$publication_place <- factor(npub$publication_place, levels = rev(unique(npub$publication_place)))

theme_set(theme_bw(20))
p <- ggplot(npub, aes(x = publication_decade, y = n)) +
       geom_bar(stat = "identity", position = "stack", color = "black",
       		    aes(fill = publication_place)) + 
       xlab("Publication year") +
       ylab("Unique publishers (n)") +
       scale_fill_brewer(palette="Greys") +       
       guides(fill = guide_legend(reverse = FALSE, title = "")) +
       ggtitle(catal)       
       #ggtitle(paste("Unique publishers in selected publication places (", catalogue, ")"))

print(p)
```

---

### Fig 9: Publishers in Swedish University towns (Kungliga)

All towns from Kungliga.

```{r Fig9, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=5, fig.width=12}
df <- df0
catal <- "Kungliga"
df <- df %>%
        filter(catalog == catal) %>%
	filter(country == "Finland" | publication_place == "Vyborg") %>%
        filter(publication_year >= 1640 & publication_year <= 1828)

# Top publication places
library(bibliographica)

top <- c("Turku", "Vaasa", "Vyborg")
df <- df %>%	
        filter(publication_place %in% top) %>%	
        select(publication_decade, publication_place, publisher)
	
npub <- unique(df) %>% group_by(publication_decade, publication_place) %>% tally()
npub$publication_place <- factor(npub$publication_place, levels = top)
npub.fennica <- npub


df <- df0
catalogue <- "Kungliga"
df <- df %>%
        filter(catalog == catalogue) %>%
        filter(publication_year >= 1640 & publication_year <= 1828)

# Selected publication places
top <- c("Stockholm", "Lund", "Uppsala", "Greifswald", "Tartu")
df <- df %>%	
        filter(publication_place %in% top) %>%	
        select(publication_decade, publication_place, publisher)
	
npub <- unique(df) %>% group_by(publication_decade, publication_place) %>% tally()
npub$publication_place <- factor(npub$publication_place, levels = top)
npub.kungliga <- npub

npub <- bind_rows(npub.fennica, npub.kungliga)

# Order by total publishing activity
npub$publication_place <- factor(npub$publication_place, levels = (npub %>% group_by(publication_place) %>% summarise(total = sum(n)) %>% arrange(desc(total)))$publication_place)
npub <- npub %>% arrange(publication_place)
npub$publication_place <- factor(npub$publication_place, levels = rev(unique(npub$publication_place)))

theme_set(theme_bw(20))
p <- ggplot(npub, aes(x = publication_decade, y = n)) +
       geom_bar(stat = "identity", position = "stack", color = "black",
       		    aes(fill = publication_place)) + 
       xlab("Publication year") +
       ylab("Unique publishers (n)") +
       scale_fill_brewer(palette="Greys") +       
       guides(fill = guide_legend(reverse = FALSE, title = "")) +
       ggtitle(catal)
       #ggtitle(paste("Unique publishers in selected publication places (", catalogue, ")"))


print(p)
```

---


### Fig 10: Publications in Vaasa in Fennica, 1750-1828


```{r Fig10, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=5, fig.width=10}
library(dplyr)
catalogue <- "Fennica"
place <- "Vaasa"
minyear <- 1750
maxyear <- 1828

df <- df0 %>% filter(catalog == catalogue & publication_place == place) %>%	
        filter(publication_year >= minyear & publication_year <= maxyear) %>%
	group_by(publication_year) %>% 
	tally()

p <- ggplot(df, aes(x = publication_year, y = n)) +
     geom_bar(stat = "identity") +
     ggtitle("") +
     scale_x_continuous(breaks = seq(minyear, maxyear, 5)) +
     xlab("Publication year") +
     ylab("Title count (n)")

print(p)
```

---


### Fig 11: Top publishers in Turku/Fennica

```{r Fig11, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=5, fig.width=10}
library(dplyr)
place <- "Turku"
catalogue = "Fennica"
df = df0

df <- df %>% filter(catalog == catalogue & publication_place == place)

df <- df %>%	
  filter(publication_year >= 1640 & publication_year <= 1828)%>%
        select(publication_decade, publisher, paper)

# Group small publishers
# Top publishers by title count
ntop <- 10
top <- names(top(df, "publisher", ntop))
df$publisher[!df$publisher %in% top] <- "Other"
df$publisher <- factor(df$publisher, c(top, "Other"))

# Title count per decade & publisher	
npub <- df %>% group_by(publication_decade, publisher) %>% tally() %>% arrange(n)
#npub$publisher <- factor(npub$publisher, levels = (npub %>% group_by(publisher) %>% summarise(total = sum(n)) %>% arrange(total))$publisher)
# Sort by biggest publication decade
#ord <- (npub %>% group_by(publisher) %>% summarise(decade = publication_decade[[which.max(n)]]) %>% arrange(decade))$publisher
ord <- as.character((npub %>% group_by(publisher) %>% 
                        summarise(decade = median(publication_decade)) %>% 
                        arrange(decade))$publisher)
npub$publisher <- factor(npub$publisher, levels = c("Other", setdiff(ord, "Other")))


# TITLE COUNT
theme_set(theme_bw(20))
p <- ggplot(npub, aes(x = publication_decade, y = publisher)) +
      geom_point(aes(size = n)) + 
      #geom_line(aes(color = publisher), size = 2) +
      #geom_smooth(aes(fill = publisher)) +
      # geom_bar(stat = "identity", position = "stack", aes(fill = publisher)) + 
       xlab("Year") +
       ylab("") +
       guides(size = guide_legend(title = "Title count (n)"))
       #ggtitle(paste("Title count per publisher (", place, "/", catalogue, ")", sep = ""))
print(p)
```

---



### Fig. 12: Title count per capita

The historical population sizes used in this analysis are shown in this [table](https://github.com/rOpenGov/bibliographica/blob/master/inst/extdata/population_sizes_in_cities.csv).

```{r Fig12, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5}
# Read historical population sizes
f <- system.file("extdata/population_sizes_in_cities.csv", package = "bibliographica")
pop <- read.csv(f)
pop <- melt(pop, "Year")
colnames(pop) <- c("publication_decade", "publication_place", "population")
pop <- as_data_frame(pop)
pop$publication_place <- as.character(pop$publication_place)

# Cities with population data
cities <- setdiff(pop$publication_place, "Year")

minyear <- 1640
maxyear <- 1828

# Take cities from Kungliga except Turku
cat <- "Kungliga"
df1 <- df0 %>% filter(publication_place %in% setdiff(cities, "Turku")) %>%
      	      filter(catalog == cat) %>%
              filter(publication_decade %in% pop$publication_decade) %>%
	      select(publication_decade, publication_place) %>%	      
	      group_by(publication_decade, publication_place) %>%
	      summarise(n = n())

# Take cities from Fennica for Turku
cat <- "Fennica"
df2 <- df0 %>% filter(publication_place %in% "Turku") %>%
      	      filter(catalog == cat) %>%
              filter(publication_decade %in% pop$publication_decade) %>%
	      select(publication_decade, publication_place) %>%	      
	      group_by(publication_decade, publication_place) %>%
	      summarise(n = n())


df <- bind_rows(df1, df2)

# Remove special chars for compatibility (table join fails otherwise)
pop$publication_place <- gsub("Linköping", "Linkoping", pop$publication_place)
df$publication_place <- gsub("Linköping", "Linkoping", df$publication_place)

# Join title count and population size
dfm <- inner_join(pop, df, by = c("publication_decade", "publication_place"))

# Add title count per capita
dfm <- dfm %>% mutate(titles_per_capita = n/population)

p <- ggplot(dfm, aes(x = publication_decade, y = titles_per_capita)) +
       geom_line(aes(linetype = publication_place), size = 1) +
       geom_point(aes(shape = publication_place), size = 5) +
       xlab("Publication decade") +
       ylab("Title count per capita (n)") +
       ggtitle("Title count per capita") +
       guides(shape = guide_legend(title = "Place")) +
       guides(linetype = guide_legend(title = "Place")) 
print(p)

#kable(dfm)
```

---



### Fig. 13: Title count (absolute)

```{r Fig13, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5}
minyear <- 1640
maxyear <- 1828

# Take cities from Kungliga except Turku
cat <- "Kungliga"
df1 <- df0 %>% filter(publication_place %in% setdiff(cities, "Turku")) %>%
      	      filter(catalog == cat) %>%
              filter(publication_decade %in% pop$publication_decade) %>%
	      select(publication_decade, publication_place) %>%	      
	      group_by(publication_decade, publication_place) %>%
	      summarise(n = n())

# Take cities from Fennica for Turku
cat <- "Fennica"
df2 <- df0 %>% filter(publication_place %in% "Turku") %>%
      	      filter(catalog == cat) %>%
              filter(publication_decade %in% pop$publication_decade) %>%
	      select(publication_decade, publication_place) %>%	      
	      group_by(publication_decade, publication_place) %>%
	      summarise(n = n())


df <- bind_rows(df1, df2)

p <- ggplot(df, aes(x = publication_decade, y = n)) +
       geom_line(aes(linetype = publication_place), size = 1) +
       geom_point(aes(shape = publication_place), size = 5) +
       xlab("Publication decade") +
       ylab("Title count (n)") +
       ggtitle("Title count (absolute)") +
       guides(shape = guide_legend(title = "Place")) +
       guides(linetype = guide_legend(title = "Place")) 
print(p)
```

---




### Fig. 14: Octavo paper consumption

Paper consumption in octavo format books in Stockholm, Turku, Uppsala,
Lund, Göteborg and Linköping. Turku is from Fennica, other cities from
Kungliga.

```{r Fig14, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5}
# Take cities from Kungliga except Turku
cat <- "Kungliga"
df1 <- df0 %>% filter(publication_place %in% setdiff(cities, "Turku")) %>%
      	       filter(catalog == cat & gatherings == "8vo") %>%
	       group_by(publication_decade, publication_place) %>%
	       summarise(n = n(), paper = sum(paper, na.rm = TRUE))

# Take cities from Fennica for Turku
cat <- "Fennica"
df2 <- df0 %>% filter(publication_place %in% "Turku") %>%
      	       filter(catalog == cat & gatherings == "8vo") %>%
	       group_by(publication_decade, publication_place) %>%
	       summarise(n = n(), paper = sum(paper, na.rm = TRUE))

df <- bind_rows(df1, df2)

p <- ggplot(df, aes(x = publication_decade, y = paper)) +
       geom_line(aes(linetype = publication_place), size = 1) +
       geom_point(aes(shape = publication_place), size = 5) +
       xlab("Publication year") +
       ylab("Paper (sheets)") +
       ggtitle("Octavo: paper consumption") +
       guides(shape = guide_legend(title = "Place")) +
       guides(linetype = guide_legend(title = "Place"))        
print(p)
```


---


### Fig. 15: Octavo title length (word count)

Average title length in words in Stockholm, Turku, Uppsala, Lund,
Göteborg and Linköping. According to Kungliga, except Turku from
Fennica. 

```{r Fig15, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5}
# Take cities from Kungliga except Turku
cat <- "Kungliga"

df00 <- df.full %>% filter(publication_year >= 1640 & publication_year <= 1850)

df1 <- df00 %>% filter(publication_place %in% setdiff(cities, "Turku")) %>%
      	       filter(catalog == cat) %>%
	       group_by(publication_decade, publication_place) %>%
	       summarise(n = n(), paper = sum(paper, na.rm = TRUE), 
	         mean_title_length = mean(title_length_wordcount, na.rm = TRUE))

# Take cities from Fennica for Turku
cat <- "Fennica"
df2 <- df00 %>% filter(publication_place %in% "Turku") %>%
      	       filter(catalog == cat) %>%
	       group_by(publication_decade, publication_place) %>%
	       summarise(n = n(), paper = sum(paper, na.rm = TRUE), 
                 mean_title_length = mean(title_length_wordcount, na.rm = TRUE))

df <- bind_rows(df1, df2)

df$publication_place[!df$publication_place == "Stockholm"] <- "Other"

p <- ggplot(df, aes(x = publication_decade, y = mean_title_length)) +
       geom_bar(aes(fill = publication_place), position = "dodge", stat = "identity") +
       xlab("Publication year") +
       ylab("Title length (words)") +
       ggtitle("Mean title length") +
       scale_fill_manual(values = c("darkgray", "black")) +
       guides(fill = guide_legend(title = "Place", reverse = TRUE))        
print(p)

```

---


### Fig 16: Language use in Turku, Stockholm, Uppsala and Lund

```{r Fig16, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
pics <- list()
theme_set(theme_bw(20))
myplaces <- c("Turku", "Greifswald", "Stockholm", "Uppsala", "Lund")

for (catalogue in c("Fennica", "Kungliga")) {

  df <- df0 %>% filter(catalog == catalogue) %>%
        filter(publication_year >= 1600 & publication_year <= 1828)

  langs <- c("Finnish", "Swedish", "Latin", "German",
           "Russian", "French", "Hebrew", "Other")

  lang <- paste("language.", langs, sep = "")
  otherlang <- setdiff(names(df)[grep("lang.", names(df))], lang)
  otherlang <- otherlang[otherlang!="language.Multiple languages"]

  df$language.Other <- rowSums(df[, otherlang] == TRUE, na.rm = T) > 0

  dfl <- NULL
  for (lan in lang) {

    # Classify a document to the specifed language
    # If document is assigned with languages, each case is considered
    # so one doc may have multiple entries corresponding to different languages
    # mean(rowSums(df[, lang]) == 1) # 93% Fennica docs have just 1 language
    # Combine data frames for specified languages
    dflsub <- filter(df, df[[lan]])
    if (nrow(dflsub) > 0) {
      dflsub$language <- gsub("language.", "", lan)
      dfl <- bind_rows(dfl, dflsub)
    }
  }

  df <- dfl %>% group_by(publication_decade, publication_place, language) %>%
     	     summarise(n = n())

  # Calculate percentages
  dff <- spread(df, language, n, fill = 0)
  dff[, -c(1,2)] <- 100 * t(apply(dff[, -c(1,2)], 1, function (x) {x/sum(x)}))

  dff <- melt(dff, id = c("publication_place", "publication_decade"))
  colnames(dff) <- c("publication_place", "publication_decade", "language", "f")

  for (myplace in myplaces) {
    p <- ggplot(subset(dff, publication_place == myplace),
      aes(x = publication_decade, y = f)) +
      geom_bar(position = "stack", stat = "identity",
      			aes(fill = language), color = "black") + 
      xlab("Publication year") +
      ylab("Title count frequency (%)") +
      ggtitle(paste(myplace, "/", catalogue)) +
      #scale_fill_brewer(palette="Spectral") +
      scale_fill_brewer(palette="Greys") +       
      guides(fill = guide_legend(title = "")) 
      #guides(fill = guide_legend(title = "")) +       
    pics[[paste(catalogue, myplace, sep = "-")]] <- p
  }
}

grid.arrange(pics[[1]],
             pics[[8]], pics[[9]], pics[[10]], 
             nrow = 2)
rm(pics)
```

---


### Fig. 17: Topic richness per language (Fennica)

```{r Fig17, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5, fig.show="hold"}
catalogue <- "Fennica"
df <- filter(df0, catalog == "Fennica") %>%
  filter(publication_year >= 1640 & publication_year <= 1828) %>%
  select(publication_year, language, subject_topic)
df <- unique(df)
df <- df %>% group_by(publication_year, language) %>%
             summarise(n = length(unique(unlist(strsplit(subject_topic, ";")))))

langs2 <- c("Finnish", "Swedish", "Latin", "Other")
df$language[!df$language %in% langs2] <- "Other"
df$language <- factor(df$language, levels = langs2)


p <- ggplot(df, aes(x = publication_year, y = n, shape = language)) +
       geom_line(size = 1, aes(linetype = language)) +
       geom_point(size = 4) +
       scale_color_brewer(palette="Greys") +
       scale_fill_brewer(palette="Greys") +                     
       geom_smooth(color = "black") +
       guides(shape = guide_legend(title = "Language")) +
       guides(linetype = guide_legend(title = "Language")) + 
       ylab("Title count (n)") +
       xlab("Publication year")

print(p)
```

---


### Fig. 18: Temporary sermons in Latin and Swedish


```{r Fig18, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5}
  sel <- c("hautajaiset", "häät", "juhlamenot")
  catalogue <- "Fennica"
  df <- df0
  df$hit <- apply((sapply(sel, function (x) {grepl(x, tolower(df$subject_topic))})), 1, any)  

  # Selected catalogue with selected topics
  df <- df %>% filter(catalog == catalogue & hit)
  lang <- paste("language.", langs, sep = "")
  otherlang <- setdiff(names(df)[grep("lang.", names(df))], lang)
  otherlang <- otherlang[otherlang!="language.Multiple languages"]
  df$language.Other <- rowSums(df[, otherlang] == TRUE, na.rm = T) > 0

  dfl <- NULL
  for (lan in lang) {
    # Classify a document to the specifed language
    # If document is assigned with languages, each case is considered
    # so one doc may have multiple entries corresponding to different languages
    # mean(rowSums(df[, lang]) == 1) # 93% Fennica docs have just 1 language
    # Combine data frames for specified languages
    dflsub <- filter(df, df[[lan]])
    if (nrow(dflsub) > 0) {
      dflsub$language <- gsub("language.", "", lan)
    dfl <- bind_rows(dfl, dflsub)
  }
}
dfl$language <- factor(dfl$language, levels = langs)

  df <- dfl %>% group_by(publication_decade, language) %>%
             summarise(n = n(),
	               paper = sum(paper, na.rm = TRUE))

  # PAPER CONSUMPTION
  p <- ggplot(df, aes(x = publication_decade, y = paper, group = language)) +
       geom_point(aes(shape = language), size = 5) +
       geom_line(aes(linetype = language), size = 1) +       
       xlab("Publication year") +
       ylab("Paper (sheets)") +
       guides(shape = guide_legend(title = "Language")) +
       guides(linetype = guide_legend(title = "Language")) + 
       #ggtitle(paste("Temporary Sermons (", catalogue, ")", sep = ""))
       ggtitle(catalogue)       
  print(p)
```

---


### Fig. 19: Devotional literature (catechisms, hymns, prayers, etc.) 

Form of literature denoting the advancement of reading in Finland in the 19th century. It has been unclear when devotional literature  shows up as a relevant category.

```{r Fig19, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6, fig.show="hold"}
sel <- c("virret","arkkiveisut","hartauskirjat","katekismukset","rukouspäivät","saarnat","aapiset","rukoukset","rukous","hengelliset laulut","hartauspuheet","virsikirjat")
catalogue <- "Fennica"

  # Selected catalogue with selected years
  df <- filter(df0, catalog == catalogue &
     		    publication_year >= 1640 &
		    publication_year <= 1828)

  # Selected topics
  df$hit <- apply((sapply(sel, function (x) {grepl(x, tolower(df$subject_topic))})), 1, any)  
  df <- df %>% filter(catalog == catalogue & hit)

  lang <- paste("language.", langs, sep = "")
  otherlang <- setdiff(names(df)[grep("lang.", names(df))], lang)
  df$language.Other <- rowSums(df[, otherlang] == TRUE, na.rm = T) > 0
  dfl <- NULL
  for (lan in lang) {
    # Classify a document to the specifed language
    # If document is assigned with languages, each case is considered
    # so one doc may have multiple entries corresponding to different languages
    # mean(rowSums(df[, lang]) == 1) # 93% Fennica docs have just 1 language
    # Combine data frames for specified languages
    dflsub <- filter(df, df[[lan]])
    if (nrow(dflsub) > 0) {
      dflsub$language <- gsub("language.", "", lan)
      dfl <- bind_rows(dfl, dflsub)
    }
  }
  df <- dfl %>% group_by(publication_decade, language) %>%
             summarise(n = n(),
	               paper = sum(paper, na.rm = TRUE))

# PAPER CONSUMPTION
theme_set(theme_bw(20))
p <- ggplot(df, aes(x = publication_decade, y = paper, group = language)) +
       geom_point(aes(shape = language), size = 5) +
       geom_line(aes(linetype = language)) +       
       xlab("Publication year") +
       ylab("Paper (sheets)") +
       guides(shape = guide_legend(title = "Language")) +
       guides(linetype = guide_legend(title = "Language")) +        
       ggtitle(catalogue)
       #ggtitle(paste("Devotional Literature (", catalogue, ")", sep = "")) 
print(p)
```

---



## Session info

This document was created with the following versions:

```{r sessioninfo, message=FALSE, warning=FALSE}
sessionInfo()
```





